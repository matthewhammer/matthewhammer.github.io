<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>CEAL: Example: Modifiable Lists</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="contents">
<h1><a class="anchor" name="ex_list_prims">Example: Modifiable Lists </a></h1>So-called <b>modifiable lists</b> are analygous to ordinary linked lists except that in a modifiable list, each cell stores the next cell (i.e., it's "tail") in a modifiable reference rather than in a ordinary pointer field. In other words, the cells of a modifiable list are instances of the following <code>struct:</code> <p>
<div class="fragment"><pre class="fragment">   <span class="keyword">typedef</span> cons_cell_s {
     <span class="keywordtype">void</span>* hd;
     <a class="code" href="group__langcore.html#g2721ca82a2a5915adb3ed5f56c27f174" title="Modifiable references.">modref_t</a>* tl;
   } cons_cell_t;
</pre></div><p>
When a meta program uses a modlist as an input to some core program, the modifiable references in the list allow the meta program to insert and delete list elements and propagate these changes through the core program (as usual, using <a class="el" href="group__langmeta.html#g266c38f39f8be698b6a37ede35325083">slime_propagate</a>).<h2><a class="anchor" name="Allocation">
Allocation</a></h2>
To initialize a new list cell, we'll use an <em>initialization function</em> like this:<p>
<div class="fragment"><pre class="fragment">   ifun cons_cell_init(cons_cell_t* cell, <span class="keywordtype">void</span>* hd) {
     cell-&gt;hd = hd;
     cell-&gt;tl = <a class="code" href="group__langcore.html#g450cffd84b888c265a63ab679946be19" title="Creates a new, empty modifiable reference and returns a pointer to it.">modref</a>();
   }
</pre></div><p>
This function initializes memory for a list cell with a given element (<code>hd</code>). It also creates an empty modref to hold the tail of the list. Given this initialization function, we'll allocate new cons cells using the <a class="el" href="group__langcore.html#g0f2f4b7eb5734fff689ce8c3cbd313da">alloc</a> primitive:<p>
<div class="fragment"><pre class="fragment">   cons_cell_t* Cons(<span class="keywordtype">void</span>* hd) {
     <span class="keywordflow">return</span> <a class="code" href="group__langcore.html#g0f2f4b7eb5734fff689ce8c3cbd313da" title="Allocate and initialize memory blocks.">alloc</a>(<span class="keyword">sizeof</span>(cons_cell_t), cons_cell_init, hd);
   }
</pre></div><p>
The <a class="el" href="group__langcore.html#g0f2f4b7eb5734fff689ce8c3cbd313da">alloc</a> primitive takes: a <em>size</em>, the number of bytes to allocate; an <em>initialization function</em>, to initialize the allocated memory; and zero or more <em>initialization arguments</em>, which are in turn passed to the initialization function. In the use above there is one initialization argument: the element to place in the "head" of the cons cell.<p>
We use the <a class="el" href="group__langcore.html#g0f2f4b7eb5734fff689ce8c3cbd313da">alloc</a> primitive instead of a conventional allocation function (e.g., <code>malloc</code>) since uses of the <a class="el" href="group__langcore.html#g0f2f4b7eb5734fff689ce8c3cbd313da">alloc</a> primitive are included in the trace of a core computation. This is significant for several reasons:<p>
<ul>
<li><b>Automatic Garbage Collection</b>: When the core program is re-evaluated by change propagation some of the old trace may be thrown away and replaced with a new computation. When the thrown-away computation contains memory allocations performed by <a class="el" href="group__langcore.html#g0f2f4b7eb5734fff689ce8c3cbd313da">alloc</a>, change propagation automatically reclaims them as garbage.</li></ul>
<p>
<ul>
<li><b>Reuse of Previous Allocations</b>: When the core program is re-evaluated and performs new allocations, the <a class="el" href="group__langcore.html#g0f2f4b7eb5734fff689ce8c3cbd313da">alloc</a> primitive attempts to <em>reuse</em> allocations from the trace when they're available. This is crucial for writing stable programs.</li></ul>
<h2><a class="anchor" name="Creating">
a List</a></h2>
ex_modlist.c <div class="fragment"><pre class="fragment"></pre></div> </div>
<hr size="1"><address style="text-align: right;"><small>Generated on Wed Mar 4 16:13:42 2009 for CEAL by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
